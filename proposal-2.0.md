# NapCat + 自研适配层 QQ × DeepSeek 机器人 Proposal 2.0

## 1. 目标与范围（最小可用闭环）
- 事件来源：NapCat OneBot WebSocket，支持群聊 @ 触发、私聊直达。
- AI 回复：调用 DeepSeek Chat Completion，支持可配置 persona/system prompt。
- 基础能力：简单限流（用户/群/全局）、上下文管理（同会话最近 N 条）、控制台日志。
- 命令系统：内置 help/reset/persona/usage；预留自定义命令注册入口。

## 2. 需要补充的关键点
- 连接可靠性：NapCat WS 断线自动重连；消息去重与自发消息过滤。
- 安全与权限：管理员 ID、白/黑名单，群级静音开关，敏感词/正则拦截。
- 稳定性：同一会话串行锁，避免并发乱序；DeepSeek 请求超时/重试。
- 可观测性：`/healthz`、`/status` HTTP 探活；调用/限流命中日志。
- 配置与持久化：`.env` 驱动配置，持久化文件存储（白名单、用量统计、静音列表）。
- 成本控制：上下文条数与摘要阈值可配，支持温度/最大 token 调参。
- 部署与运维：Docker Compose 双容器（NapCat + Bot），开箱即跑；日志默认输出到 stdout。
- 可测试性：最小单测/集成测试用 mock WebSocket + mock DeepSeek，验证命令与限流路径。

## 3. 技术架构
NapCat（OneBot 事件/发送接口） ⇄ 自研 Node/TS Bot 服务 ⇄ DeepSeek API

模块划分：
- OneBot 适配：WS 客户端、事件解析、发送消息封装（群/私聊区分，带引用）。
- 会话与上下文：按 guild/channel/user 生成会话键，最近 N 条保留，可选摘要压缩。
- 命令路由：前缀/@ 触发解析，内置命令 + 自定义命令注册器。
- 限流：令牌桶/计数器，用户/群/全局三个维度，命中时回包等待时间。
- AI 调用：DeepSeek 客户端（超时、重试、错误降级），支持 persona/system prompt。
- 状态存储：JSON 文件持久化白/黑名单、静音列表、用量统计。
- 观测：HTTP 探活/状态，控制台结构化日志。
- 架构原则：低耦合 + 高内聚，核心逻辑与适配层解耦；通过依赖注入传入配置、适配器与客户端，方便替换 OneBot/LLM/存储实现。

## 4. 功能设计要点
- **触发规则**：群聊需 @ 机器人（可配置群内无 @ 也响应）；私聊直接响应；过滤自己发送的消息。
- **命令**：`/help` `/reset` `/persona <name>` `/usage`；管理员：`/allow` `/deny` `/mute-on` `/mute-off` `/config` `/status`；自定义命令通过注册器扩展。
- **限流**：默认用户/群/全局每分钟阈值可配；命中后提示剩余等待时间。
- **上下文**：按会话保存最近 N 条，超出触发摘要（摘要走 DeepSeek 低温设定），并裁剪旧记录。
- **日志**：所有入站事件、命令执行、AI 请求结果/失败、限流命中，均打到 stdout。
- **配置化**：`.env` 可设 OneBot 端点/Token、自身 QQ、管理员列表、模型参数、限流、上下文阈值、敏感词正则、persona 预设 JSON。
- **解耦与注入**：Bot 核心通过接口依赖 OneBot 适配器、限流器、存储、AI 客户端，使用依赖注入传入实现；方便未来替换为其他协议（如 HTTP/反向 WS）、其他模型（OpenAI/本地）、或持久化后端（文件/Redis/DB）。

## 5. 非功能需求
- 可靠性：NapCat 断线重连、心跳检测；AI 请求 30s 超时；错误兜底提示用户稍后再试。
- 安全性：API Key 仅从环境变量读取；敏感词拦截；管理员命令权限校验。
- 部署：提供 `docker-compose.yml` 与 `.env.example`，一键 `docker compose up -d`；数据卷持久化。
- 可维护性：代码分层（适配/逻辑/存储/限流），少量注释，易扩展命令与策略。

## 6. 里程碑
- **MVP**：事件收发闭环（群 @/私聊）、DeepSeek 回复、限流、上下文 N 条、基础命令、控制台日志、Docker 启动。
- **V1**：白/黑名单与静音、敏感词拦截、摘要裁剪、健康检查接口、错误重试、配置化 persona/模型。
- **V2（可选）**：RAG/工具调用、文件/图片能力、持久化存储升级、指标上报（Prometheus）、管理 Web 控制台。

## 7. 验收标准
- Docker Compose 启动后，群 @ 与私聊均可得到 AI 回复，平均延迟可接受。
- 限流命中有明确提示，超出阈值不再向 DeepSeek 发送请求。
- 同一会话上下文生效，可通过 `/reset` 清空，`/persona` 生效。
- 管理命令生效（白/黑名单、静音、配置查询），敏感词可拦截。
- `/healthz` 返回 200，日志包含事件、命令、AI 调用与错误信息。 
